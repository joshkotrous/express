#!/usr/bin/env bash

echo

# Check if required arguments are provided
if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
    echo "Error: Missing required arguments."
    echo "Usage: $0 <middleware> <node_script> <connections>"
    exit 1
fi

# Reject inputs with dangerous shell characters
if [[ "$1" =~ ['"\;|&<>()`${}\\\\] ]]; then
    echo "Error: MW value contains characters that could be used for command injection."
    exit 1
fi

if [[ "$2" =~ ['"\;|&<>()`${}\\\\] ]]; then
    echo "Error: Node script path contains characters that could be used for command injection."
    exit 1
fi

# Validate that connections is a positive integer
if ! [[ "$3" =~ ^[1-9][0-9]*$ ]]; then
    echo "Error: Connections must be a positive integer."
    exit 1
fi

# Execute the command with proper quoting
MW="$1" node "$2" &
pid=$!

echo "  $3 connections"

sleep 2

wrk 'http://localhost:3333/?foo[bar]=baz' \
  -d 3 \
  -c "$3" \
  -t 8 \
  | grep 'Requests/sec\|Latency' \
  | awk '{ print " " $2 }'

kill $pid